<html>
<head>
	
	<title>分布式锁的几种实现方式</title>
	<meta name="keywords" content="IT,PL,CS..." />

    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

    
    <!--<link rel="stylesheet" href="/css/main.css">-->
	<link href="/css/main.css?v=2" rel="stylesheet" type="text/css" />
    <!--<link rel="stylesheet" href="/css/style.css">-->
    

    <link rel="alternate" type="application/atom+xml" href="/atom.xml" title="Atom feed">

    
	<link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2"/>
    

</head>

<body>

<h2 id="分布式锁的几种实现方式"><a href="#分布式锁的几种实现方式" class="headerlink" title="分布式锁的几种实现方式"></a>分布式锁的几种实现方式</h2><blockquote>
<p>DB</p>
</blockquote>
<p>并发下的问题：</p>
<p>​    丢失更新：一个事务的更新覆盖了其它事务的更新结果。A把值从6改为2，B把值从6改为3。A的更新结果丢失。</p>
<p>​    脏读：一个事务读取其它完成一半事务的记录时，就会发生脏读取。A、B读到值都为6，B把值改为2，A认为的值仍为6。</p>
<ul>
<li><p>悲观锁</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from table where id = 1 for update;//行级锁 要有明确的主键</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">select * from table for update;//表级锁</div></pre></td></tr></table></figure>
<p>注：此时只有执行完了for update操作，即该事务commit后，其他select for update、update操作才会执行，但单纯的select操作完全可以执行。</p>
</li>
<li><p>乐观锁</p>
<p>使用版本号或者时间戳。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">select x1,x2 ... ,version from table where x1 = 1;</div><div class="line">update table set version = version + 1 where x1 = 1 and version = ?</div></pre></td></tr></table></figure>
<p>乐观锁不能解决脏读的问题。</p>
</li>
</ul>
<blockquote>
<p>Redis</p>
</blockquote>
<p>​    4个命令：setnx get setget del</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">long</span> exsits = setNX(lock.key,System.curtime + timeout);</div><div class="line"></div><div class="line"><span class="comment">//获得锁</span></div><div class="line"><span class="keyword">if</span>(exsits == <span class="number">1</span>)&#123;</div><div class="line">	<span class="comment">//todo business</span></div><div class="line">  	...</div><div class="line">    ...</div><div class="line">    <span class="comment">//防止死锁</span></div><div class="line">    <span class="keyword">if</span>( doBusinessTime &lt; timeout)&#123;</div><div class="line">          del(lock.key);</div><div class="line">    &#125;</div><div class="line">&#125;<span class="keyword">else</span>&#123;<span class="comment">//exsits == 0</span></div><div class="line">	<span class="keyword">long</span> oldExpireTime = get(lock.key);</div><div class="line">    <span class="comment">//锁过期</span></div><div class="line">  	<span class="keyword">if</span>(oldExpireTime &lt; System.curtime)&#123;</div><div class="line">      <span class="keyword">long</span> _oldExpireTime = setget(lock.key, System.curtime + timeout);</div><div class="line">      <span class="comment">//锁没有被其他线程（进程）操作</span></div><div class="line">      <span class="keyword">if</span>(oldExpireTime == _oldExpireTime)&#123;</div><div class="line">        <span class="comment">//获得锁</span></div><div class="line">        <span class="comment">//todo business</span></div><div class="line">        ...</div><div class="line">        ...</div><div class="line">        <span class="comment">//防止死锁</span></div><div class="line">        <span class="keyword">if</span>( doBusinessTime &lt; timeout)&#123;</div><div class="line">              del(lock.key);</div><div class="line">        &#125;<span class="keyword">else</span>&#123;</div><div class="line">        	<span class="comment">//重试或者阻塞</span></div><div class="line">        &#125;</div><div class="line">      &#125;<span class="keyword">else</span>&#123;</div><div class="line">        <span class="comment">//重试或者阻塞</span></div><div class="line">      &#125;</div><div class="line">  	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>​    注：timeout 的值应根据业务来设，因为当业务逻辑执行时间过长，比timeout长时，依然存在并发问题。</p>
<p>​        这几个命令在redis集群下情况将很复杂，将会有问题。</p>
<blockquote>
<p>Zookeeper</p>
</blockquote>



<div style="display:none">
<!-- analyse javascript -->
</div>







</body>
</html>